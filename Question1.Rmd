---
title: "Question 1"
output: html_document
---

## GEDI for Predicting AGB across Space and Time.

The Global Ecosystem Dynamics Investigation (GEDI) was a spaceborne lidar mission in operation from March 2019 to March 2023. The GEDI lidar instrument transmitted pulses of light to the Earth's surface in 25m footprints and measured the intensity of pulse returns as full waveforms. Each waveform was processed to determine the ground return and isolate the proportion of return intensity at relative heights above the ground. The resulting GEDI L2A Canopy Height product provides a global sample of precise three-dimensional structural properties of vegetation.

The GEDI L4A product is a modelled estimate of AGB for every GEDI footprint using various L2A Canopy Height Metrics as predictor variables alongside coincident field and airborne lidar data. The L4A product models were stratified by Plant Functional Type (PFT) and geographic region. The miombo region encompasses a combination of Deciduous Broadleaf Trees (DBT) and Grasslands, Shrublands, and Woodlands (GSW). The model developed for African GSW was not among the best performing models, most likely due to the limited training data available. The model developed for African DBT utilised 490 training samples and yielded R2 = 0.63, %RMSE = 57.24, and MRE = 8.14 Mg ha -1 (Duncanson et al, 2022). The strongest predictor variables from the L2A product were the 98th and 50th percentiles: RH98 and RH50. The general lack of representative training data in the miombo region, whether African DBT or GSW, is an important, inherent limitation of the L4A product to consider, yet outside of the scope of this study to interrogate further (Ploton et al, 2020).

This study aims to develop a model of AGB for each of the five study areas (MGR, TKW, MMB, ABG, CBN) as a function of GEDI L4A data, topography, optical satellite data (surface reflectance and phenological statistics) [Question 2], and Synthetic Aperture Radar (SAR) data [Question 3]. Once modelled, this study aims to predict AGB across each of the study areas to produce spatially contiguous estimates of AGB, then extrapolate predictions across time, and ultimately use coincident SEOSAW AGB data for product validation.

To develop a model of AGB, the target variable (GEDI L4A) and predictor variables (surface reflectance, phenology statistics, topography, and radar backscatter) must align over space and in time. In this case, the total cumulative area covered by GEDI footprints over the three years from August 2019 to July 2022 ranges from 2.1% to 5.6% across sites, and is fairly consistent from year to year. It is ideal to use the complete range of available GEDI data from 2020 to 2022 to maximise the input training data for AGB model development and ultimately improve the reliability of subsequent AGB products. However, the GEDI Science team have highlighted that in African savannas, citing results from South Africa, there is significantly greater bias in L2A data during leaf-off conditions than leaf-on (Li et al, 2023). Bias in RH98, a core predictor variable in the African DBT model, was 34% greater in leaf-off conditions.

```{r biomass_data include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")


df_biomass <- read.csv("/home/s1949330/Documents/scratch/diss_data/gedi/gedi_data.csv")
df <- df_biomass %>% filter(!is.na(AGB_Mean))
plot_biomass <- ggplot(df, aes(x = factor(Site), desc(AGB_Mean), y = AGB_Mean, fill = Site)) +
  geom_flat_violin(position = position_nudge(x = 0.2, y = 0), alpha = 0.8) +
  geom_point(aes(y = AGB_Mean, color = Site), position = position_jitter(width = 0.15), size = 1, alpha = 0.2) + 
  geom_boxplot(width = 0.2, outlier.shape = NA, alpha = 0.8) +
  scale_y_continuous(breaks = seq(0, max(df$AGB_Mean, na.rm = TRUE), by = 50)) +
  labs(title = "GEDI Biomass Across Study Sites, 2019-2022", y = "\nBiomass (Mg/ha)", x = "\nSite") +
  guides(fill = "none", color = "none") +
  scale_fill_manual(values = c("#5A4A6F", "#9D5A6C",  "#EBB261", "#E47250", "#c33333")) +
  scale_colour_manual(values = c("#5A4A6F", "#9D5A6C",  "#EBB261", "#E47250", "#c33333")) +
  coord_flip() +
  theme_classic() + 
  theme(panel.grid.major = element_line(color = "grey95"),
        panel.grid.minor = element_line(color = "grey95"))

print(plot_biomass)

df_sample <- read.csv('/home/s1949330/Documents/scratch/diss_data/gedi/gedi_sample.csv')
plot_sample <- ggplot(df_sample, aes(x = factor(Site), y = Coverage, fill = Site)) +
  geom_bar(stat = "identity", width = 0.75) +
  labs(title = "GEDI Sample Across Study Sites, 2019-2022", y = "Area (%)", x = "Site") +
  theme_classic() +
  scale_fill_manual(values = c("#5A4A6F", "#9D5A6C",  "#EBB261", "#E47250", "#c33333")) +
  scale_y_continuous(limits = c(0, 10), breaks = seq(0, 10, by = 1)) +
  theme(panel.grid.major = element_line(color = "grey95"), legend.position = "none")

print(plot_sample)
```

Fundamentally, AGB is not expected to change between seasonal/phenological cycles given that the largest proportion of AGB in DBT and GSW is held in the woody components of vegetation, and that held in foliage is seldom significant by comparison. Hence, evidence of seasonal variation in the L4A product found by Li et al (2023), suggests there is may be a balance between the spatial representativeness of input L4A training data and the temporal alignment or synchronicity with intended predictor variables i.e., the significance of L4A variation across seasons. Addressing this balance in the L4A data appropriately would reduce the risk of model overfitting subsequent uncertainty in spatially contiguous AGB estimates. To determine this balance the following research question is posed:

## How consistent is the GEDI L4A product across seasons in each study area?

*L2A Predictor Variables*

-   RH98, RH50, RH25, RH0, ERA Precipitation

```{r height_data include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

df_height <- df_biomass[, c("Site", "Date", "RH98_Mean", "RH50_Mean", "RH25_Mean", "RH0_Mean",
                            "RH98_StErr", "RH50_StErr", "RH25_StErr", "RH0_StErr", "ERA_Prcp")]
df_height$Date <- as.Date(df_height$Date, format = "%d/%m/%Y")
df_height <- df_height[complete.cases(df_height), ]
max_height <- max(df_height[, c("RH98_Mean", "RH50_Mean", "RH25_Mean", "RH0_Mean")], na.rm = TRUE)
max_precip <- max(df_height$ERA_Prcp, na.rm = TRUE)

plot_heights <- lapply(unique(df_height$Site), function(site) {
  df_site <- subset(df_height, Site == site)
  ggplot(df_site, aes(x = Date)) +
    geom_hline(yintercept = 0, color = "black", linetype = "solid", size = 0.5) + 
    geom_point(aes(y = RH98_Mean, color = "RH98"), size = 2) +
    geom_point(aes(y = RH50_Mean, color = "RH50"), size = 2) +
    geom_point(aes(y = RH25_Mean, color = "RH25"), size = 2) +
    geom_point(aes(y = RH0_Mean, color = "RH0"), size = 2) +
    geom_errorbar(aes(ymin = RH98_Mean - RH98_StErr, ymax = RH98_Mean + RH98_StErr), color = "forestgreen", width = 0.2) +
    geom_errorbar(aes(ymin = RH50_Mean - RH50_StErr, ymax = RH50_Mean + RH50_StErr), color = "#32cd32", width = 0.2) +
    geom_errorbar(aes(ymin = RH25_Mean - RH25_StErr, ymax = RH25_Mean + RH25_StErr), color = "orange", width = 0.2) +
    geom_errorbar(aes(ymin = RH0_Mean - RH0_StErr, ymax = RH0_Mean + RH0_StErr), color = "indianred", width = 0.2) +
    geom_col(aes(y = ERA_Prcp * (max_height / max_precip), fill = "Precipitation"), alpha = 0.15) +
    scale_y_continuous(name = "Height (m)",
                       sec.axis = sec_axis(~ . * (max_precip / max_height), name = "Precipitation (mm)")) +
    labs(title = paste("GEDI Relative Height Metrics, 2019-2022:", site), x = "Date", color = "Legend", fill = "") +
    scale_color_manual(values = c("RH98" = "forestgreen", "RH50" = "#32cd32", "RH25" = "orange", "RH0" = "indianred")) +
    scale_fill_manual(values = c("Precipitation" = "steelblue")) +
    theme_classic() +
    theme(panel.grid.major = element_line(color = "grey95"),
          panel.grid.minor = element_line(color = "grey95"),
          panel.grid.minor.y = element_line(color = "gray95"))
})

plot_heights

```

*L4A Time Series*

-   AGB Time Series
-   Autocorrelation Function (ACF) plot
-   Auto-Regression Model (AR) plot

```{r biomass_data include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lubridate)
library(dplyr)

# Extract data
df_AGB <- df_biomass[, c("Site", "Date", "AGB_Mean", "AGB_StErr")]
df_AGB$Date <- as.Date(df_AGB$Date, format = "%d/%m/%Y")
df_AGB <- df_AGB[complete.cases(df_AGB), ]

# Isolate years of data
categorize_year <- function(date) {
  year <- year(date)
  month <- month(date)
  if (year == 2019 && month >= 8 || year == 2020 && month <= 7) {
    return("2019-20")} 
  else if (year == 2020 && month >= 8 || year == 2021 && month <= 7) {
    return("2020-21")}
  else if (year == 2021 && month >= 8 || year == 2022 && month <= 7) {
    return("2021-22")}
  else {
    return(NA)}}
df_AGB$Year_Category <- sapply(df_AGB$Date, categorize_year)
df_AGB <- df_AGB[!is.na(df_AGB$Year_Category), ]
df_AGB$Month <- month(df_AGB$Date, label = TRUE, abbr = TRUE)
df_AGB$Month <- factor(df_AGB$Month, levels = c("Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"))

# Plot annual series of biomass
plot_AGB <- lapply(unique(df_AGB$Site), function(site) {
  df_site <- subset(df_AGB, Site == site)
  ggplot(df_site, aes(x = Month, y = AGB_Mean, color = Year_Category, group = Year_Category)) +
    geom_point(size = 2) +
    geom_line(aes(group = Year_Category, color = Year_Category), size = 0.5) +
    geom_errorbar(aes(ymin = AGB_Mean - AGB_StErr, ymax = AGB_Mean + AGB_StErr), width = 0) +
    labs(title = paste("GEDI Aboveground Biomass, 2019-2022:", site), x = "Month", y = "AGB (Mg/ha)", color = "Legend") +
    scale_color_manual(values = c("2019-20" = "darkred", "2020-21" = "steelblue", "2021-22" = "forestgreen")) +
    theme_classic() +
    theme(panel.grid.major = element_line(color = "grey95"),
          panel.grid.minor = element_line(color = "grey95"),
          panel.grid.minor.y = element_line(color = "gray95"))
})
plot_AGB

```

```{r biomass_ACF include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Read data
site_data <- read.csv("/home/s1949330/Documents/scratch/diss_data/gedi/gedi_data.csv")
site_data$Date <- as.Date(site_data$Date, format = "%d/%m/%Y")

# Function to create ACF data frame
create_acf_df <- function(df_site) {
  biomass_ts <- ts(df_site$AGB_Mean, start = c(year(min(df_site$Date)), month(min(df_site$Date))), frequency = 12)
  acf_values <- acf(biomass_ts, na.action = na.pass, lag.max = length(biomass_ts) + 1, plot = FALSE)
  acf_df <- data.frame(Lag = 1:length(acf_values$acf[-1]), ACF = acf_values$acf[-1])
  return(acf_df)
}

# Calculate the significance threshold
significance_threshold <- function(n) {
  return(1.96 / sqrt(n))
}

# Create ACF plots
plot_acf_list <- lapply(unique(site_data$Site), function(site) {
  df_site <- subset(site_data, Site == site)
  acf_df <- create_acf_df(df_site)
  n <- nrow(df_site)
  threshold <- significance_threshold(n)
  
  ggplot(acf_df, aes(x = Lag, y = ACF)) +
    geom_hline(yintercept = 0, color = "black", linetype = "solid", size = 0.5) +
    geom_hline(yintercept = c(-threshold, threshold), col = "darkred", linetype = "dashed") +
    geom_bar(stat = "identity", width = 0.25, fill = "steelblue", alpha = 0.5) +
    geom_line(color = "black", size = 0.5) +
    geom_point(color = "black", size = 1) +
    labs(title = paste("Autocorrelation of GEDI Biomass Data:", site), x = "Lag (Months)", y = "Autocorrelation") +
    theme_classic() +
    theme(panel.grid.major = element_line(color = "grey95"),
          panel.grid.minor = element_line(color = "grey95"),
          panel.grid.minor.y = element_line(color = "gray95"))
})

# Display the plots
plot_acf_list

```

```{r biomass_AR include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Read data
site_data <- read.csv("/home/s1949330/Documents/scratch/diss_data/gedi/gedi_data.csv")
site_data$Date <- as.Date(site_data$Date, format = "%d/%m/%Y")

#Function to create AR model plot
plot_ar_model <- function(df_site) {
biomass_ts <- ts(df_site$AGB_Mean, start = c(year(min(df_site$Date)), month(min(df_site$Date))), frequency = 12)
AR <- arima(biomass_ts, order = c(1,0,0))
AR_model <- biomass_ts - residuals(AR)
AR_model_se <- sqrt(diag(AR$var.coef))
df_site$Date <- as.Date(df_site$Date)
df_site$AR_model <- as.numeric(AR_model)
df_site$AR_model_upper <- df_site$AR_model + 1.96 * AR_model_se
df_site$AR_model_lower <- df_site$AR_model - 1.96 * AR_model_se
ggplot(df_site, aes(x = Date)) +
    geom_point(aes(y = AGB_Mean, color = "GEDI AGB"), size = 1.5) +
    geom_line(aes(y = AGB_Mean, color = "GEDI AGB"), size = 0.5, linetype = "solid") +
    geom_point(aes(y = AR_model, color = "AR Model"), size = 1.5) +
    geom_line(aes(y = AR_model, color = "AR Model"), size = 0.5, linetype = "solid") +
    geom_errorbar(aes(ymin = AGB_Mean - AGB_StErr, ymax = AGB_Mean + AGB_StErr, color = "GEDI AGB"), width = 0.2) +
    geom_errorbar(aes(ymin = AR_model_lower, ymax = AR_model_upper, color = "AR Model"), width = 0.2) +
    scale_color_manual(values = c("GEDI AGB" = "blue4", "AR Model" = "red")) +
    labs(title = paste("Auto-Regression Model of GEDI Biomass:", unique(df_site$Site)),
         x = "Date", y = "AGB (Mg/ha)", color = "Legend") +
    theme_classic() +
    theme(panel.grid.major = element_line(color = "grey95"),
          panel.grid.minor = element_line(color = "grey95"),
          panel.grid.minor.y = element_line(color = "gray95")) +
    ylim(0, NA)
}

#Create AR model plots for each site
plot_ar_list <- lapply(unique(site_data$Site), function(site) {
df_site <- subset(site_data, Site == site)
plot_ar_model(df_site)
})

#Display the plots
plot_ar_list
```


## Interpretation of the Time Series Analysis

*Predictor Variables*

The visualisation of L2A RH metrics, RH98 and RH50, shows fairly cyclical trend most likely attributed to seasonal patterns and changes in foliage as in Li et al (2023). The addition of precipitation data to the plot of RH98 and RH50 supports this notion as the distinct peaks in rainfall coincide with increases in canopy heights and the clear dry seasons where rainfall is limited coincides with decreases in canopy height. This preliminary analysis demonstrates the motivation and importance of the research question, with initial indications that the GEDI L4A product, for which RH98 and RH50 are predictor variables, may not be seasonally consistent and require more consideration for the potential temporal asynchronicity of predictor variables in subsequent upscaling efforts.

*Biomass Product*

The visualisation of the L4A product across each site show fairly different patterns and trends. TKW is variable across years but does not appear overtly seasonal. Similarly, CBN shows very little evidence of seasonality yet consistent biomass across years. MMB also shows similar patterns across years but with a slight indication of a seasonal signal. ABG shows notably less biomass than most of the other sites with some variation but not alike expected seasonality. MGR shows the most significant evidence of a seasonal signal but there are numerous NAs across years which limits the reliability of this interpretation.

Beyond the visualisation of the L4A product, it is important to quantify the extent to which successive biomass estimates are correlated to reveal any underlying seasonal signals within the time series at each site. Temporal autocorrelation was assessed to show how predictable biomass estimates at given time lags i.e., number of months. High ACF values suggest a stronger predictability of observations in the dataset whereby the raw data may exhibit a seasonal signal. Low ACF values suggest a weaker predictability of the dataset and indicate more random residuals and more independence of the data. In all but CBN, the sites are expected to roughly follow the six month seasonal cycle typical across DBT in the miombo region. CBN, on the other hand may show a different seasonal cycle if any, given its greater proximity to the equator and the subsequent differences in phenology and precipitation-fire regimes.

In general across all sites, the L4A product demonstrates a degree of temporal autocorrelation. In most cases, the variations in autocorrelation are apparent albeit outside the 95% confidence threshold. Nonetheless, this assessment demonstrates sufficient evidence of temporal autocorrelation across sites to warrant a time series model to accomodate for the variations in biomass estimates. 

- **TKW** = -0.16, -0.04, 0.15: A fair range of values though no strong or statistically significant evidence of seasonality distinct from noise. Up to 15% chance of predicting successive biomass estimates.
- **MGR** = -0.27, -0.01, 0.18: A large range of values with notably peaks in negative correlations though no statistical significant evidence of seasonality distinct from noise. Up to 27% change of predicting successive biomass estimates.
- **MMB** = -0.14, -5.67, 0.23: A large range of values with a general trend towards negative values with two notable exceptions in a peak of around 20% chance of predictability with a twelve month lag.
- **ABG** = -0.29, -0.03, 0.49: The largest range of values with the only case of statistically significant autocorrelation with a one month lag. There is also a fairly distinct seasonal cycle in temporal autocorrelation, though below 95% confidence, where predictability nearly reaches 30%.
- **CBN** = -0.28, 0.00, 0.29: A large range of values with no statistically significant autocorrelations but with visible and apparent variations and even reversals in three month lags. Predictability of biomass estimates reaches 30%.

*Auto-Regression Model*

An Auto-Regressive (AR) Model assesses time series data and provides a statistical expanation for the extent to which a given monthly biomass estimate is a function of its previous monthly biomass estimates. An AR model produces more comprehensive measures of average monthly biomass and errors alonside AR metrics representing the strength at which a given month biomass estimate is related to its previous month estimate. MGR and MMB exhibit the lowest AR values suggesting that biomass estimates are unlikely to be related to previous month estimates, however, MGR shows a standard error of 0.36 pointing to the large degree of uncertainty in the interpretation. TKW and CBN have fairly high AR values at -0.22 and 0.20 respectively, though the standard errors are again very high in comparison, at 0.30 and 0.18. ABG exhibits the larges AR value whereby monthly biomass estimates are strongly related to those preceeding them. 

- **TKW** = -0.22 (0.30), 45.06 (4.52)
- **MGR** = 0.04 (0.36), 44.32 (3.35)
- **MMB** = -0.02 (0.17), 66.71 (8.07)
- **ABG** = 0.51 (0.15), 11.93 (2.40)
- **CBN** = 0.20 (0.18), 27.87 (4.13)

*Implications*

This analysis has shown that the GEDI L4A product is not consistent over seasons across the study areas in the miombo region. The modelled biomass estimate shows considerably less seasonality than the L2A predictor variables, RH98 and RH50, but there is nonetheless general evidence of temporal autocorrelation and autoregression. This has important implications for the subsequent modelling efforts in this study, whereby the variation and seasonality of L4A product needs to be appropriately considered. To ensure the most effective and reliable balance of temporal synchrocinity across predictor variables while maximising the amount of training data to reduce potential model overfitting, three preliminary (random forest) models will be constructed with different temporal constraints: leaf-on (interpreted where monthly precipitation exceeds 30 mm), leaf-off, and when all data is included. Any significant differences in bias between models will inform the temporal constraints adopted for the L4A training data in the primary deep learning model [Question 2].


## References

Duncanson, L.; Kellner, J.; Armston, J.; Dubayah, R.; Minor, D.; Hancock, S.; Healey, S.; Patterson, P.; Saarela, S.; Marselis, S. et al. (2022). Aboveground Biomass Density Models for NASA's Global Ecosystem Dynamics Investigation (GEDI) Lidar Mission. Remote Sensing of Environment, 270, p1-20.

Li, X.; Wessels, K.; Armston, J.; Hancock, S.; Mathieu, R.; Main, R.; Naidoo, L.; Erasmus, B.; Scholes, R. (2023). First Validation of GEDI Canopy Heights in African Savannas. Remote Sensing of Environment, 285, p1-17.

Ploton, P.; Mortier, F.; Réjou-Méchain, M.; Barbier, N.; Picard, N.; Rossi, V.; Dormann, C.; Cornu, G.; Veinnois, G.; Bayol, N. et al. (2020). Spatial Validation Reveals Poor Predictive Performance of Large-Scale Ecological Mapping Models. Nature Communications, 11(4540), p1-11.